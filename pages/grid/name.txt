<template>
    <section class="fancy-table" style="width: 100%; height: 100%">
        <div id="table" ref="table" v-if="tableName && table"></div>
        <img v-else src="https://nabels.ru/upload/preload.gif" />
    </section>
</template>

<script>
import {TabulatorFull as Tabulator} from 'tabulator-tables';

export default {
    layout: "admin",
    components: {
        FancyGridVue,
    },
    head() {
        return {
            title: "Редактор таблиц",
        };
    },

    data() {
        return {
            tableName: null,
            table: null,
            columns: [],
            rows: [],
        };
    },
    mounted() {
        this.$store.commit("SET_APP_TITLE", "Редактор таблиц");
        this.tableName = this.$route.params.name;
        this.refresh();
    },
    computed: {},

    methods: {
        showLoader(display) {
            this.$store.commit("SHOW_LOADER", display);
        },
        async refresh() {
            this.showLoader(true);
            this.$api("table", this.tableName, "get").then(async (data) => {
                this.showLoader(false);
                this.columns = data.info.columns;
                this.rows = data.rows;
                this.gridConfig.title = data.info.name;
                this.gridConfig.data = data.rows;
                this.gridConfig.combos = {};
                this.gridConfig.columns = await Promise.all(
                    Object.keys(this.columns).map(async (fldName) => {
                        let editable = false;
                        let type = "string";
                        let width = this.columns[fldName].width || 150;
                        let format = null;
                        let hidden = this.columns[fldName].hidden || false;
                        let cls = "";

                        if (this.columns[fldName].type == "images") {
                            cls = "image-cell";
                            width = 80;
                        }

                        let render = (obj) => {
                            if (this.columns[fldName].type == "date" || this.columns[fldName].type == "dateTime") {
                                obj.value = obj.data[fldName + "_text"];
                            }
                            if (this.columns[fldName].type == "select") {
                                obj.value = this.columns[fldName].items[obj.value];
                            }
                            if (this.columns[fldName].type == "linkTable") {
                                obj.value = obj.data[fldName + "_text"];
                            }
                            if (this.columns[fldName].type == "images") {
                                let itm = obj.data[fldName] ? obj.data[fldName][0] : null;
                                obj.value = itm ? itm.src : "";
                                if (obj.value) obj.value = "<img src='" + obj.value + "' style='height:31px;'>";
                            }
                            return obj;
                        };
                        return { type, index: fldName, title: this.columns[fldName].label, width, editable, format, hidden, render, cls };
                    })
                );
                //console.log(this.$el, this.$el.getBoundingClientRect());
                this.gridConfig.width = this.$el.getBoundingClientRect().width - 10;
                this.gridConfig.height = this.$el.getBoundingClientRect().height - 10;
                this.gridConfig.visible = true;
                //console.log(this.gridConfig);
            });
        },
    }, //methods
};
</script>

<style>
.image-cell .fancy-grid-cell-inner {
    padding: 0;
    margin: 0;
    text-align: center;
}
</style>
